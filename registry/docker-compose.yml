services:
  zot:
    image: ghcr.io/project-zot/zot-linux-arm64:latest
    platform: linux/arm64
    container_name: zot-registry
    restart: unless-stopped
    ports:
      - "5001:5000"  # Expose port 5001 on host -> 5000 in container for Docker CLI access
    env_file:
      - .env
    environment:
      # HTTP configuration
      HTTP_ADDRESS: ${HTTP_ADDRESS:-0.0.0.0}
      HTTP_PORT: ${HTTP_PORT:-5000}
      
      # Authentication
      AUTH_USER: ${AUTH_USER:-admin}
      AUTH_PASS: ${AUTH_PASS:-change-this-password}
    volumes:
      - zot_data:/var/lib/zot
      - ./config:/etc/zot:ro
    networks:
      - proxy
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.registry.entrypoints=websecure"
      - "traefik.http.routers.registry.rule=Host(`registry.lan`)"
      - "traefik.http.routers.registry.tls=true"
      - "traefik.http.services.registry.loadbalancer.server.port=5000"
      - "traefik.http.routers.registry.middlewares=registry-headers"
      - "traefik.http.middlewares.registry-headers.headers.customrequestheaders.X-Forwarded-Proto=https"
      - "traefik.http.middlewares.registry-headers.headers.customrequestheaders.X-Forwarded-Host=registry.lan"

volumes:
  zot_data:

networks:
  proxy:
    external: true
